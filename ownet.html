
<script type="text/javascript">
    RED.nodes.registerType('owserver',{
        category: 'config',
        defaults: {
            host: { value: 'localhost', required: true },
            port: { value: '4304', required: true, validate: RED.validators.number() },
        },
        label: function(){
            return this.host + ':' + this.port;
        }
    });
</script>

<script type="text/x-red" data-template-name="owserver">
    <div class="form-row">
        <label for="node-config-input-host"><i class="icon-bookmark"></i> Host</label>
        <input type="text" id="node-config-input-host" placeholder="localhost">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="icon-tag"></i> Port</label>
        <input type="text" id="node-config-input-port" placeholder="4304">
    </div>
</script>

<!-- end owserver config node -->

<script type="text/javascript">
    RED.nodes.registerType('ownet read',{
        defaults: {
            owserver:           { value:'', type:'owserver'},
            devpath:			{ value:'', required:true },
            subpath:			{ value:'', required:true },
            name: 				{ value:'' }
        },
        category:   'ownet',
        color:      '#169cf5',
        inputs:     1,
        outputs:    1,
        icon:	    'arrow-in.png',
        align:	    'right',
        label: function() { return 'Read 1-wire device ' + this.devpath; },
        oneditprepare: function() {
            var server = RED.nodes.node(this.owserver);
            try {
                $("#node-input-devpath").autocomplete("destroy");
                $("#node-input-subpath").autocomplete("destroy");
            }
            catch (err) {}

            $("#node-input-lookup-devpath").click(function(){
                $("#node-input-lookup-devpath").addClass('disabled');
                $.getJSON('ownet/ls?host=' + server.host + '&port=' + server.port, function(data) {
                    $("#node-input-lookup-devpath").removeClass('disabled');
                    var devices;
                    devices = data.slice();
                    $("#node-input-devpath").autocomplete({
                        source:devices,
                        minLenght:0,
                        close: function( event , ui ){
                            $("#node-input-devpath").autocomplete("destroy");
                        }
                    }).autocomplete("search","/");
                });
            });
            $("#node-input-lookup-subpath").click(function(){
                $("#node-input-lookup-subpath").addClass('disabled');
                $.getJSON('ownet/ls?host=' + server.host + '&port=' + server.port + '&path=' + $("#node-input-devpath").val(),function(data) {
                    $("#node-input-lookup-subpath").removeClass('disabled');
                    var propers = [];
                    var excluded_paths = new RegExp("/(?:address|crc8|errata|family|id|locator|r_[a-z]+)$");
                    $.each(data, function(id,value) {
                        value = value.substr(16);
                        if(!value.match(excluded_paths)){
                            propers.push(value);
                        }
                    });
                    $("#node-input-subpath").autocomplete({
                        source:propers,
                        minLenght:0,
                        close: function( event , ui ){
                            $("#node-input-subpath").autocomplete("destroy");
                        }
                    }).autocomplete("search","/");
                });
            });
        },
        oneditsave: function() {
        }
    });
</script>

<script type="text/x-red" data-template-name="ownet read">
    <div class="form-row">
        <label for="node-input-owserver"><i class="fa fa-tag"></i> OWSERVER</label>
        <input type="text" id="node-input-owserver">
    </div>
    <div class="form-row">
        <label for="node-input-devpath"><i class="fa fa-cogs"></i> ROM Code</label>
        <input type="text" id="node-input-devpath" style="width: 56%" data-i18n="[placeholder]devpath">
        <a id="node-input-lookup-devpath" class="btn"><i id="node-input-lookup-devpath-icon" class="fa fa-search"></i></a>
    </div>
    <div class="form-row">
        <label for="node-input-subpath"><i class="fa fa-sliders"></i> Property</label>
        <input type="text" id="node-input-subpath" style="width: 56%">
        <a id="node-input-lookup-subpath" class="btn"><i id="node-input-lookup-subpath-icon" class="fa fa-search"></i></a>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="ownet read">
   <p>Read value from 1-wire device over owserver(owfs.org).</p>
   <p>Output <b>msg.topic</b> containing owfs path,</p>
   <p> include device id and property,</p>
   <p> <b>ex</b> /28.97CA2E020000/temperature10</p>
   <p><b>msg.payload</b> containing value as string.</p>
</script>

<!-- end ownet device read node -->

<script type="text/javascript">
    RED.nodes.registerType('ownet write',{
        category: 'ownet',
        color:"#f54616",
        inputs:1,
        outputs:1,
        icon:	"arrow-in.png",
        align:	"right"
    });
</script>

<script type="text/x-red" data-template-name="ownet write">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- end ownet device write node -->


<script>
/*
    function deviceIDListPopulate() {
        $("#node-input-devicesIDList").empty();
        $.getJSON("ownet/ls").done(function(data) {
            $.each(data["devices"], function(id,value) {
                value = value.replace(new RegExp("/", "g"), ""); // remove leading "/"
                $("#node-input-devicesIDList").append($('<option value="' + value + '">' + value + '</option>'));
            });
            var t = $("#node-input-deviceID").val();
            $("#node-input-devicesIDList [value='" + t + "']").attr("selected", "selected");
        });
    };

    function devicePropertyListPopulate(deviceID) {
        var blacklist = new RegExp("/(?:address|crc8|errata|family|id|locator|r_[a-z]+)$");
        $("#node-input-devicePropList").empty();
        $.getJSON("ownet/ls?path=" + deviceID).done(function(data) {
            $.each(data["devices"], function(id,value) {
                value = value.substr(16);
                if(!value.match(blacklist)){
                    $("#node-input-devicePropList").append($('<option value="' + value.substr(1) + '">' + value.substr(1) + '</option>'));
                };
            });
            var t = $("#node-input-deviceProp").val();
            $("#node-input-devicePropList [value='" + t + "']").attr("selected", "selected");
        });
    };
*/
</script>
